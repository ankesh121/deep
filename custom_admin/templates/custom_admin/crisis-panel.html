{% extends 'base.html' %}
{% load watchful_url %}

{% block title %}
DEEP | Crisis Manager
{% endblock %}

{% block head %}

<link rel="stylesheet" type="text/css" href="{% watchful_static_url 'css/selectize.css' %}"/>
<link href="{% watchful_static_url 'css/crisis-panel.css' %}" type="text/css" rel="stylesheet">
<script type="text/javascript" src="{% watchful_static_url 'js/common/selectize.js' %}"></script>
<script type="text/javascript" src="{% watchful_static_url 'js/common/utils.js' %}"></script>
<script type="text/javascript" src="{% watchful_static_url 'js/custom-admin/crisis-panel.js' %}"></script>

<script>
var crises = {
    {% for event in events %}
    "{{event.pk}}": {
        name: "{{event.name|escapejs}}", countries: [{% for country in event.countries.all %}"{{country.pk}}",{%endfor%}],
        start_date: "{{event.start_date|date:'Y-m-d'}}", end_date: "{{event.end_date|date:'Y-m-d'}}",
        status: "{{event.status}}",
        disaster_type: "{{event.disaster_type.pk}}",
        assigned_to: [
            {% for assigned_to in event.assignee.all %}"{{assigned_to.pk}}", {% endfor %}
        ],
        glide_number: "{{event.glide_number}}",
        spillover: {% if event.spill_over %}"{{event.spill_over.pk}}"{% else %}null{% endif %},
        usergroups: [{% for group in event.usergroup_set.all %}"{{group.pk}}", {% endfor %}],
        admins: [{% for admin in event.admins.all %}"{{admin.pk}}", {% endfor %}],
    },
    {% endfor %}
};

var defaultGroupSelection = {% if selected_group %}["{{selected_group}}"]{% else %}""{% endif %};
var defaultAdminSelection = ["{{request.user.pk}}"];
</script>

{% endblock %}

{% block body %}
<nav>
    <header>
        <a title="DEEP" href="{% url 'login' %}"><img class="deep-logo" src="{% watchful_static_url 'img/deep-logo-sm-white.png' %}"></a>
        <h1>Crisis Management Panel</h1>
    </header>
    <!-- <a href="{% url 'login' %}"><i class="fa fa-long-arrow-left"></i>Back to DEEP</a> -->
    <a onclick="window.location.href = document.referrer;"><i class="fa fa-long-arrow-left"></i>Back</a>
</nav>

<aside>
    <div id="crisis-header">
        <h2>Crises</h2>
        <a id="add-new-crisis-btn" onclick="addNewCrisis()"><i class="fa fa-plus fa-lg data-toggle="tooltip" data-placement="bottom" title="Add New Crisis" "></i></a>
        <div id="search-wrapper">
            <input id="crisis-search" placeholder="Search crisis">
            <i class="fa fa-search"></i>
        </div>
        <div id="crisis-status-radio">
            <label class="active"><input name="crisis-status-radio" value="2" type="radio" checked>All</label>
            <label><input name="crisis-status-radio" value="0" type="radio">Global Monitoring</label>
            <label><input name="crisis-status-radio" value="1" type="radio">Active Crisis</label>
        </div>
    </div>
    <div id="crisis-list">
        {% for event in events %}
        <div class="crisis {% if event.pk == selected_event %}active{% endif %}" data-crisis-status="{{ event.status }}" data-crisis-pk="{{ event.pk }}">{{event.name}}</div>
        {% endfor %}
    </div>
</aside>

<main>
    <div id="crisis-detail">
        <form method="post" action="{% url 'custom_admin:crisis_panel' %}">
            {%csrf_token%}
            <h2>Add new crisis</h2>
            <input type="hidden" name="crisis-pk" id="crisis-pk" value="new">
            <div>
                <label>Name</label>
                <br>
                <input name="crisis-name" type="text" id="crisis-name" placeholder="Enter crisis name" required>
            </div>
            <div>
                <label>Crisis Status</label>
                <div id="crisis-status-wrapper">
                    <label><input class="crisis-status" name="crisis-status" value="0" type="radio">Global Monitoring</label>
                    <label><input class="crisis-status" name="crisis-status" value="1" type="radio" checked>Active Crisis</label>
                </div>
            </div>
            <div>
                <label> Disaster Type </label>
                <select name="disaster-type" id="disaster-type" placeholder="Select disaster type">
                    <option value="">Select disaster type</option>
                    {% for disaster_type in disaster_types %}
                    <option value="{{disaster_type.pk}}">{{disaster_type.name}}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label><a target="_blank" href="http://glidenumber.net/">Glide Number<span class="fa fa-external-link" style="margin-left: 8px;"></span></a></label>
                <input name="glide-number" type="text" id="glide-number" placeholder="Enter Glide Number">
            </div>
            <div>
                <label> Countries </label>
                <select name="countries" id="countries" placeholder="Select countries" multiple>
                    <option value="">Select countries</option>
                    {% for country in countries %}
                    <option value="{{country.pk}}">{{country.name}}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="date-field-wrapper">
                <div>
                    <label id="padded-label">Start date:</label>
                    <div style="position: relative;">
                        <input name="crisis-start-date" type="date" id="crisis-start-date" required>
                    </div>
                </div>
                <div>
                    <label id="padded-label">End date:</label>
                    <div style="position: relative;">
                        <input name="crisis-end-date" type="date" id="crisis-start-date">
                    </div>
                </div>
            </div>
            <div>
                <label>User groups</label>
                <select name="user-groups" id="user-groups" placeholder="User groups" multiple>
                    <option value="">User groups</option>
                    {% for group in usergroups %}
                    <option value="{{group.pk}}">{{group.name}}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label> Assigned To </label>
                <select name="assigned-to" id="assigned-to" placeholder="Assigned to" multiple>
                    <option value="">Assigned to</option>
                    {% for u in users %}
                    {% if u.first_name != "" %}
                    <option value="{{u.pk}}">{{u.get_full_name}}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Admins</label>
                <select name="admins" id="admins" placeholder="Admins" multiple>
                    <option value="">Admins</option>
                    {% for u in users %}
                    {% if u.first_name != "" %}
                    <option value="{{u.pk}}">{{u.get_full_name}}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div>
                <label> Spillover Effect </label>
                <select name="spillover" id="spillover" placeholder="Spillover effect">
                    <option value="">Spillover</option>
                    {% for e in events %}
                    <option value="{{e.pk}}">{{e.name}}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="action-buttons">
                <button class='btn-danger' name="delete" id="delete-btn"onclick="return confirm('Are you sure you want to delete this crisis?');" hidden> <i class='fa fa-trash'></i>Delete Crisis</button>
                <div></div>
                <button class='btn-info' id="save-btn" name="save"> <i class='fa fa-save'></i>Save Crisis</button>
            </div>
        </form>
    </div>
</main>
{% endblock %}
