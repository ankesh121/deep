{% extends 'base.html' %}
{% load staticfiles %}

{% block title %}
DEEP | {% if entry %}Edit{% else %}Add{% endif %} Entry
{% endblock %}

{% block head %}
<link href="{% static 'css/split-pane.css' %}" type="text/css" rel="stylesheet">
<link href="{% static 'css/add-entry.css' %}" type="text/css" rel="stylesheet">
<link href="{% static 'css/selectize.css' %}" type="text/css" rel="stylesheet">
<link href="{% static 'css/selectize.bootstrap3.css' %}" type="text/css" rel="stylesheet">

<script type="text/javascript" src="{% static 'js/selectize.js' %}"></script>
<script type="text/javascript" src="{% static 'js/split-pane.js' %}"></script>
<script type="text/javascript" src="{% static 'js/utils.js' %}"></script>
<script type="text/javascript" src="{% static 'js/add-entry.js' %}"></script>
<script type="text/javascript" src="{% static 'js/add-entry-map.js' %}"></script>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css">
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>

<link rel="stylesheet" href="{% static 'css/leaflet.label.css' %}" >
<script src="{% static 'js/leaflet.label.js' %}"></script>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script>
    var cancelUrl = "{% url 'entries:entries' event.pk %}";

    // Simplified version of the lead.
    var leadSimplified = "{% if lead_simplified %}{{lead_simplified|escapejs}}{% endif %}";
    leadSimplified = leadSimplified.replace(/(?:\r\n|\r|\n)/g, '<br />');
    // Is simplified option selected?
    var isSimplified;

    // Attributes
    var pillars = {
        {% for pillar in pillars_one %}
        {{pillar.pk}}: {
            name: "{{pillar | safe}}", subpillars: {
                {% for subpillar in pillar.informationsubpillar_set.all %}{{subpillar.pk}}: "{{subpillar | safe}}",{% endfor %}
            }
        },
        {% endfor %}
        {% for pillar in pillars_two %}
        {{pillar.pk}}: {
            name: "{{pillar | safe}}", subpillars: {
                {% for subpillar in pillar.informationsubpillar_set.all %}{{subpillar.pk}}: "{{subpillar | safe}}",{% endfor %}
            }
        },
        {% endfor %}
    };

    var sectors = {
        {% for sector in sectors %}
        {{sector.pk}}: {
            name: "{{sector | safe}}", subsectors: {
                {% for subsector in sector.subsector_set.all %}{{subsector.pk}}: "{{subsector | safe}}",{% endfor %}
            }
        },
        {% endfor %}
    };

    // Reliabilities and severities
    var defaultReliability = "{{default_reliability.pk}}";
    var defaultSeverity = "{{default_severity.pk}}";

    // Affected groups
    var affectedGroups = [
        {% for ag in affected_groups %}['{{ag}}', {% if ag.parent %}'{{ag.parent}}'{% else %}null{% endif %}, ''],{% endfor %}
    ];
    var agRowIdMap = {
        {% for ag in affected_groups %}{{ forloop.counter0 }}:{{ ag.pk }},{% endfor %}
    };
    var agIdRowMap = {
        {% for ag in affected_groups %}{{ ag.pk }}:{{ forloop.counter0 }},{% endfor %}
    };

    // CSRF Token
    var csrf_token = "{% csrf_token %}";


    // For editing, pass previous excerpts
    var excerpts = [
    {% if entry %}{% for excerpt in entry.entryinformation_set.all %}
        {
            excerpt: "{{excerpt.excerpt|escapejs}}",
            attributes: [
                {% for attr in excerpt.informationattribute_set.all %}
                {
                    pillar: {{attr.subpillar.pillar.pk}}, subpillar: {{attr.subpillar.pk}},
                    sector: {% if attr.sector %}{{attr.sector.pk}},
                    subsectors:
                        {% if attr.subsectors %}
                            [{% for ss in attr.subsectors.all %}{{ss.pk}}, {% endfor %}]
                        {% else %}null{% endif %}
                    {% else %}null, subsector: null{% endif %}
                },
                {% endfor %}
            ],
            reliability: {{excerpt.reliability.pk}},
            severity: {{excerpt.severity.pk}},
            date: {% if excerpt.date %}"{{excerpt.date|date:"Y-m-d"}}"{% else %}null{% endif %},
            number: {% if excerpt.number %}{{excerpt.number}}{% else %}null{% endif %},
            affected_groups: [ {% for ag in excerpt.affected_groups.all %}{{ag.pk}},{% endfor %} ],
            vulnerable_groups: [ {% for vg in excerpt.vulnerable_groups.all %}{{vg.pk}},{% endfor %} ],
            specific_needs_groups: [ {% for sg in excerpt.specific_needs_groups.all %}{{sg.pk}},{% endfor %} ],
            map_selections: [
                {% for ms in excerpt.map_selections.all %}
                    {% if ms.pcode == "" %}
                    "{{ms.admin_level.country.code}}:{{ms.admin_level.level|add:'-1'}}:{{ms.name}}",
                    {% else %}
                    "{{ms.admin_level.country.code}}:{{ms.admin_level.level|add:'-1'}}:{{ms.name}}:{{ms.pcode}}",
                    {% endif %}
                {% endfor %}
            ],

        },
    {% endfor %}{% endif %}
    ];

    // Default date
    var defaultDate = {% if lead.published_at %}"{{lead.published_at|date:"Y-m-d"}}"{% else %}null{% endif %};
</script>

{% endblock %}

{% block body %}
{% include 'navbar.html' %}
<div id="page-one">
    <div class="split-pane fixed-left">
        <div class="split-pane-component" id="left-component">

            {% if lead_simplified %}
            <div id="lead-options-container">
                <div class="row">
                    <div class="col-md-8">
                        <div class="btn-group" data-toggle="buttons" {% if lead.lead_type == 'MAN' %} style="display:none;" {% endif %}>
                            <label class="btn btn-default radio-inline active"><input type="radio" name="lead-view-option" value="simplified" checked>Simplified</label>
                            <label class="btn btn-default radio-inline"><input type="radio" name="lead-view-option" value="original">Original</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div id="zoom-buttons">
                            <button class="btn btn-regular btn-zoom" id="zoom-out" data-toggle="tooltip" title="zoom out"><i class="fa fa-search-minus"></i></button>
                            <button class="btn btn-regular btn-zoom" id="zoom-in" data-toggle="tooltip" title="zoom in"><i class="fa fa-search-plus"></i></button>
                            <div id="tag-buttons" style="max-height:200px; overflow:auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div id="lead-preview-container">
                {% if lead.lead_type == 'URL' %}
                <iframe id="lead-preview" src="{{ lead.url }}"></iframe>
                {% elif lead.lead_type == 'ATT' %}
                <iframe id="lead-preview" src="{{ lead.attachment.upload.url}}"></iframe>
                {% endif %}
                <div id="lead-simplified-preview">{{lead_simplified|safe|escape}}</div>
            </div>

        </div>
        <div class="split-pane-divider" id="divider"></div>
        <div class="split-pane-component" id="right-component">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-5" style="padding-right: 0">
                        <select class="form-control" placeholder="Select excerpt" id="select-excerpt">
                            <option>Excerpt 1</option>
                            <option>Excerpt 2</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" id="add-excerpt" onmouseover="$(this).tooltip('show')" data-toggle="tooltip" data-placement="bottom" title="Add Excerpt"><i class="fa fa-plus"></i></button>
                        <button class="btn btn-danger" id="delete-excerpt" onmouseover="$(this).tooltip('show')" data-toggle="tooltip" data-placement="bottom" title="Delete Excerpt"><i class="fa fa-minus"></i></button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary" id="edit-entries-btn">Edit Entries <i class="fa fa-long-arrow-right"></i></button>
                        <button class="btn btn-danger cancel" onmouseover="$(this).tooltip('show')" data-toggle="tooltip" data-placement="bottom" title="Cancel"><i class="fa fa-times"></i></button>
                        <button class="btn btn-primary save-excerpt" onmouseover="$(this).tooltip('show')" data-toggle="tooltip" data-placement="bottom" title="Save Excerpt"><i class="fa fa-save"></i></button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <textarea class="form-control" id="excerpt-text" placeholder="Excerpt"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div id="matrix-one">

                            {% for pillar in pillars_one %}
                            <div class="pillar">
                                <div class="pillar-header">{{pillar}}</div>
                                {% for subpillar in pillar.informationsubpillar_set.all %}
                                <div class="sub-pillar" data-pillar-id="{{pillar.pk}}" data-subpillar-id="{{subpillar.pk}}">{{subpillar}}</div>
                                {% endfor %}
                            </div>
                            {% endfor %}

                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <table id="matrix-two">
                            <thead>
                                <td><td>
                                {% for sector in sectors %}
                                <td class="sector">{{sector}}</td>
                                {% endfor %}
                            </thead>
                            <tbody>
                                {% for pillar in pillars_two %}
                                {% for subpillar in pillar.informationsubpillar_set.all %}
                                <tr>
                                    {% if forloop.first %}
                                    <td class="pillar-header" style="background-color:{{pillar.background_color}};" rowspan="{{pillar.informationsubpillar_set.count}}">
                                        {{pillar}}
                                    </td>
                                    {% endif %}
                                    <td class="subpillar" style="background-color:{{pillar.background_color}};">{{subpillar}}</td>

                                    {% for sector in sectors %}<td class="attribute-block" data-pillar-id="{{pillar.pk}}" data-subpillar-id="{{subpillar.pk}}" data-sector-id="{{sector.pk}}" data-bk-color="{{pillar.background_color}}" data-active-bk-color="{{pillar.active_background_color}}"></td>{% endfor %}
                                </tr>
                                {% endfor %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="page-two" hidden>
    <div class="container-fluid">
        <div style="text-align: right">
            <button class="btn btn-danger cancel" onmouseover="$(this).tooltip('show')" data-toggle="tooltip" data-placement="bottom" title="Cancel"><i class="fa fa-times"></i></button>
            <button class="btn btn-primary save-excerpt" onmouseover="$(this).tooltip('show')" data-toggle="tooltip" data-placement="bottom" title="Save Excerpt"><i class="fa fa-save"></i></button>
            <button id="back-to-excerpts-btn"  class="btn btn-primary"><i class="fa fa-long-arrow-left"></i>Back to excerpts</button>
        </div>
        <div id="entries">
        </div>
    </div>
</div>

<div class="entry-template" hidden>
    <div class="row">
        <div class="col-md-2">
            <textarea class="form-control excerpt" ></textarea>
        </div>
        <div class="col-md-5">
            <div class="row">
                <div class="col-sm-3">
                    <div class="reliability">
                        <label>Reliability </label><br>
                        {% for reliability in reliabilities %}
                        <span data-id="{{reliability.pk}}" class="_{{reliability.level}}" onmouseover="$(this).tooltip('show')" data-toggle="tooltip" data-placement="bottom" title="{{reliability}}"></span>
                        {% endfor %}
                    </div>
                    <div class="severity">
                        <label>Severity </label><br>
                        {% for severity in severities %}
                        <span data-id="{{severity.pk}}" class="_{{severity.level}}" onmouseover="$(this).tooltip('show')" data-toggle="tooltip" data-placement="bottom" title="{{severity}}"></span>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-sm-4">
                    <div style="position: relative;">
                        <input type="date" class="entry-date form-control form-group" placeholder="Date">
                    </div>
                    <input type="number" step="1" min="0" class="entry-number form-control form-group" placeholder="Number">
                </div>
                <div class="col-md-5">
                    <select class="vulnerable-group-select" class="form-control form-group" placeholder="Select vulnerable group" multiple>
                        {% for vg in vulnerable_groups %}
                        <option value="{{vg.pk}}">{{vg}}</option>
                        {% endfor %}
                    </select>
                    <select class="specific-need-group-select" class="form-control form-group" placeholder="Select specific need group" multiple>
                        {% for sg in specific_needs_groups %}
                        <option value="{{sg.pk}}">{{sg}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="row">
                <div class="col-md-5">
                    <div class="affected-group">
                        <label>Affected groups:</label><a class="btn-affected btn btn-primary btn-sm" data-toggle="modal" data-target="#affected-groups-modal"><img src="{% static 'img/organigram.png' %}"></a>
                        <div class="affected-group-list"></div>
                    </div>
                    <div class="geo-location">
                        <label>Geo locations:</label><a class="btn-map btn btn-primary btn-sm" data-toggle="modal" data-target="#map-modal"><img src="{% static 'img/mapicon.png' %}"></a>
                        <div class="geo-locations-list"></div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="attribute-list">
                    </div>
                </div>
                <div class="col-md-2">
                    <a class="edit-entry-btn btn btn-primary btn-action"><i class="fa fa-edit"></i></a>
                    <a class="delete-entry-btn btn btn-danger btn-action"><i class="fa fa-times"></i></a>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="attribute-template" hidden>
    <div class="row">
        <div class="col-md-6">
            <span class="pillar"></span> <br> <span class="sub-pillar"></span>
        </div>
        <div class="col-md-6">
            <span class="sector"></span> <br> <span class="dropdown" ><span class='sub-sector-list'></span><a class="sub-sector" data-toggle="dropdown"></a><ul class="dropdown-menu pull-right"></ul></span>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="map-modal" class="modal fade" role="dialog" >
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Select locations</h4>
            </div>
            <div class="modal-body">
                <div id="the-map"></div>
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-12">
                                <div id="admin-level-buttons"></div>
                            </div>
                            <div class="col-md-6">
                                <!-- Country selection -->
                                <select name="country" id="country" placeholder="Select a country">
                                    {% for country in event.countries.all %}
                                    <option value="{{country.pk}}">{{country.name}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <!-- Manual location input -->
                                <select name="manual-location-input" id="manual-location-input" placeholder="Add a location">
                                    <option value="">Add a location</option>
                                </select>
                            </div>

                        </div>
                    </div>
                    <div class="col-md-4">
                        <div id="selected-location-list">
                            <p id="empty-text" hidden>No location added!</p>
                            <ul>
                            </ul>
                        </div>
                    </div>
                </div>
                <hr>
                <div style="text-align: right">
                    <a class="btn btn-warning" id="apply-all-map">Apply to all</a>
                    <a class="btn btn-info" id="apply-next-map">Apply to next</a>
                    <a class="btn btn-primary" id="apply-current-map">Apply to current</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="affected-groups-modal" class="modal fade" role="dialog" >
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Select affected groups</h4>
            </div>
            <div class="modal-body">
                <div id="chart-div"></div>
            </div>
            <div class="modal-footer">
                <a class="btn btn-warning apply-all-btn" id="apply-all-affected">Apply to all</a>
                <a class="btn btn-info" id="apply-next-affected">Apply to next</a>
                <a class="btn btn-primary" id="apply-current-affected">Apply to current</a>
            </div
        </div>
    </div>
</div>
{% endblock %}
