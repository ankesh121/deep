{% extends 'base.html' %}
{% load staticfiles %}

{% block title %}
DEEP | {% if entry %}Edit{% else %}Add{% endif %} Entry
{% endblock %}

{% block head %}

<link href="{% static 'css/add-entry.css' %}" type="text/css" rel="stylesheet">
<link href="{% static 'css/selectize.css' %}" type="text/css" rel="stylesheet">
<link href="{% static 'css/selectize.bootstrap3.css' %}" type="text/css" rel="stylesheet">
<link href="{% static 'css/split-pane.css' %}" type="text/css" rel="stylesheet">

<script type="text/javascript" src="{% static 'js/selectize.js' %}"></script>
<script type="text/javascript" src="{% static 'js/split-pane.js' %}"></script>
<script type="text/javascript" src="{% static 'js/utils.js' %}"></script>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css">
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>

<!-- <link rel="stylesheet" href="{% static 'css/leaflet.css' %}" />
<script src="{% static 'js/leaflet.js' %}"></script> -->

<link rel="stylesheet" href="{% static 'css/leaflet.label.css' %}" >
<script src="{% static 'js/leaflet.label.js' %}"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script>
    // Is simplified option selected?
    var isSimplified;
    // Simplified version of the lead.
    var leadSimplified = "{% if lead_simplified %}{{lead_simplified|escapejs}}{% endif %}";
    leadSimplified = leadSimplified.replace(/(?:\r\n|\r|\n)/g, '<br />');

    // Sectors and tags.
    var sectors = {
        {% for sector, ss in sectors.items %} "{{sector.name}}": "{{sector.title}}", {% endfor %}
    };
    var tags = {
        {% for sector, ss in sectors.items %} "{{sector.name}}": {{sector.tags_json|safe}}, {% endfor %}
    };

    // Currently selected tags and their colors.
    var selectedTags = {
    };

    // Current map selections.
    var mapSelections = [
    {% if prev_entry %}
    {% for selection in prev_entry.map_selections.all %}
    "{{selection.admin_level.country.code}}:{{selection.admin_level.level|add:"-1"}}:{{selection.name}}",
    {% endfor %}
    {% elif entry %}
    {% for selection in entry.map_selections.all %}
    "{{selection.admin_level.country.code}}:{{selection.admin_level.level|add:"-1"}}:{{selection.name}}",
    {% endfor %}
    {% endif %}
    ];

    // Information attributes.
    var attrs = [
    {% for group, attributes in attributes.items %}
        {
            'id': {'pk': '{{group.pk}}', 'text': '{{group.name|safe}}'},
            'data': [
        {% for attribute in attributes %}
            {'pk': '{{ attribute.pk }}', 'text': '{{attribute.name|safe}}'},
        {% endfor %}
            ],
            'class_name': '{{ group.class_name }}'
        },
    {% endfor %}
    ];

    // Affected groups.
    // name, parent, tooltip.
    var affected_groups = [
        {% for group in affected_groups %}
        ['{{group}}', '{% if group.parent %}{{group.parent}}{% endif %}', ''],
        {% endfor %}
    ];

    // CSRF Token Tag for Form.
    var csrf_token = "{% csrf_token %}";

    // Fill the attributes.
    var attr_data = {
    {% if keep_all %}
    {% if attr_data %}{% for pk, ad in attr_data.items %}
        "{{pk}}": {
            "id": "{{pk}}",
            "data": [{% for data in ad.data %}"{{data|escapejs}}",{% endfor %}],
            "number": [{% for number in ad.number %}"{{number}}",{% endfor %}],
            "reliability": [{% for reliability in ad.reliability %}"{{reliability}}",{% endfor %}],
            "severity": [{% for severity in ad.severity %}"{{severity}}",{% endfor %}],
        },
    {% endfor %}{% endif %}
    {% endif %}
    };

    // Select affected groups.
    var selected_groups = [
    {% if entry %}{% for group in affected_groups %}
    {% if group in entry.affected_groups.all %}{row:{{forloop.counter0}}, column:null},{% endif %}
    {% endfor %}
    {% elif prev_entry %}{% for group in affected_groups %}
    {% if group in prev_entry.affected_groups.all %}{row:{{forloop.counter0}}, column:null},{% endif %}
    {% endfor %}{% endif %}
    ];
</script>

<style>
    {% for group, attributes in attributes.items %}
    .{{group.class_name}} {
        background-color: {{group.color}};
        color: {{group.text_color}};
    }
    .{{group.class_name}}.active {
        background-color: {{group.selected_color}};
        color: {{group.selected_text_color}};
    }
    .{{group.class_name}}.filled {
        color: {{group.selected_color}};
    }
    .{{group.class_name}}.active.filled {
        background-color: {{group.selected_color}};
        color: {{group.selected_text_color}};
    }
    {% endfor %}
</style>

{% endblock %}

{% block body %}
{% include 'navbar.html' %}


<div id="map-modal" class="modal fade" role="dialog" >
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Select locations</h4>
            </div>
            <div class="modal-body">
                <div id="the-map"></div>
            </div>
            <div class="modal-footer">
                <div id="admin-level-buttons"></div>
            </div>
        </div>
    </div>
</div>


<div class="split-pane fixed-left">
    <div class="split-pane-component" id="left-component">
        {% if lead_simplified %}
        <div id="lead-options-container">
            <div class="btn-group" data-toggle="buttons" {% if lead.lead_type == 'MAN' %} style="display:none;" {% endif %}>
                <label class="btn btn-default radio-inline active"><input type="radio" name="lead-view-option" value="simplified" checked>Simplified</label>
                <label class="btn btn-default radio-inline"><input type="radio" name="lead-view-option" value="original">Original</label>
            </div>
            <button class="btn btn-regular btn-zoom" id="zoom-out" data-toggle="tooltip" title="zoom out"><i class="fa fa-search-minus"></i></button>
            <button class="btn btn-regular btn-zoom" id="zoom-in" data-toggle="tooltip" title="zoom in"><i class="fa fa-search-plus"></i></button>
            <div id="tag-buttons" style="max-height:200px; overflow:auto;"></div>
        </div>
        {% endif %}

        <div id="lead-preview-container">
            {% if lead.lead_type == 'URL' %}
            <iframe id="lead-preview" src="{{ lead.url }}"></iframe>
            {% elif lead.lead_type == 'ATT' %}
            <iframe id="lead-preview" src="{{ lead.attachment.upload.url}}"></iframe>
            {% endif %}
            <div id="lead-simplified-preview">{{lead_simplified|safe|escape}}</div>
        </div>
    </div>

    <div class="split-pane-divider" id="my-divider"></div>

    <div class="split-pane-component" id="right-component">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-7">
                    <div id="locations-container">
                        <h4>Locations</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <select name="country" id="country" placeholder="Select a country">
                                        {% for country in countries %}
                                        <option value="{{country.pk}}" {% if entry and entry.country == country %}selected{% endif %}>{{country.name}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-9">
                                            <select name="manual-location-input" id="manual-location-input" class="form-control"  placeholder="Add a location">
                                                <option value="">Add a location</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#map-modal"><i class="fa fa-map"></i></button>
                                        </div>
                                    </div>
                                </div>

                                <div id="vulnerable-groups-container">
                                    <h5>Vulnerable Groups</h5>
                                    <select id="vulnerable-groups" name="vulnerable-groups" class="form-control" placeholder="Select vulnerable group" multiple="true">
                                        {% for vulnerable_group in vulnerable_groups %}
                                        <option value="{{vulnerable_group.pk}}" {% if keep_all %}{% if vulnerable_group in entry.vulnerable_groups.all or vulnerable_group in prev_entry.vulnerable_groups.all %}selected{% endif %}{% endif %}>{{vulnerable_group}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="selected-location-list">
                                    <p id="empty-text" hidden>No location added!</p>
                                    <ul>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div id="specific-need-groups-container">
                                    <h5> Groups with specific needs </h5>
                                    <select id="groups-with-specific-needs" name="groups-with-specific-needs" class="form-control" placeholder="Select groups with specific needs" multiple="true">
                                        {% for specific_group in specific_needs_groups %}
                                        <option value="{{specific_group.pk}}" {% if keep_all %}{% if specific_group in entry.specific_needs_groups.all or specific_group in prev_entry.specific_needs_groups.all %}selected{% endif %}{% endif %}>{{specific_group}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="sectors-container">
                                    <h5>Sectors and subsectors</h5>
                                    <select id="sectors-subsectors" name="sectors-subsectors" class="form-control" placeholder="Select sectors subsectors" multiple="true">
                                    {% for sector, ss in sectors.items %}
                                    <option value="{{sector.pk}}" {% if keep_all %}{% if sector in entry.sectors.all or sector in prev_entry.sectors.all %}selected{% endif %}{% endif %}>{{sector.title}}</option>
                                    {% for subsector in ss %}
                                    <option value="{{subsector.pk}}" {% if keep_all %}{% if subsector in entry.sectors.all or subsector in prev_entry.sectors.all %}selected{% endif %}{% endif %}>{{sector.title}} / {{subsector.title}}</option>
                                    {% endfor %}
                                    {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-5">
                    <h4>Affected Groups</h4>
                    <div id="chart-div"></div>

                    <br>

                    <div>
                        <label>Date of the information:</label>
                        <div class="row">
                            <div class="col-md-6">
                                <input id="entry-date" type="date" class="form-control end-date" value="{% if entry %}{{ entry.date|date:'Y-m-d' }}{% elif prev_entry %}{{ prev_entry.date|date:'Y-m-d' }}{% elif lead.published_at %}{{ lead.published_at|date:'Y-m-d'  }}{% endif %}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="information-attributes">
                <h4>Information Attributes</h4>
                <div class="row">
                    <div class="col-md-5">
                        <div id="attr-contents">
                        </div>
                    </div>

                    <div class="col-md-6" id="attr-inputs">
                        <div id="selected-attr-title"></div>
                        <div id="contents"></div>
                    </div>
                </div>
            </div>

            <button id="cancel-btn" class="btn btn-danger" onclick="if (confirm('All changes will be discarded. Are you sure?')) location.href='{% url 'entries:entries' event.pk %}';" onmouseover="$(this).tooltip('show')" data-toggle="tooltip" data-placement="left" title="Cancel"><i class="fa fa-times"></i></button>
            
            <button id="save-btn" class="btn btn-primary" onmouseover="$(this).tooltip('show')" data-toggle="tooltip" data-placement="left" title="Save"><i class="fa fa-save"></i></button>

            <button id="save-add-btn" class="btn btn-default" onmouseover="$(this).tooltip('show')" data-toggle="tooltip" data-placement="left" title="Save and add another"><i id="save-icon" class="fa fa-save"></i><i id="plus-icon" class="fa fa-plus"></i></button>

            <button id="save-add-map-btn" class="btn btn-default" onmouseover="$(this).tooltip('show')" data-toggle="tooltip" data-placement="left" title="Save and add another"><i id="save-icon" class="fa fa-save"></i><i id="plus-icon" class="fa fa-plus"></i></button>

        </div>
    </div>
</div>

<div class="template-attr-input" hidden>
    <div class="row">
        <div class="col-xs-10">
            <textarea class="form-control" placeholder="Excerpt"></textarea>
        </div>
        <div class="col-xs-2">
            <button class="btn btn-primary btn-add" >+</button>
        </div>
    </div>
    <div class="row" style="padding-top:8px;">
        <div class="col-xs-3">
            <input type="number" class="form-control" placeholder="Number">
        </div>
        <div class="col-xs-4">
            <select class="severity form-control">
                <option value="NOA">-- Select Severity --</option>
                {% for serverity in severities %}
                <option value="{{serverity.0}}">{{serverity.1}}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-xs-4">
            <select class="reliability form-control">
                <option value="NOA">-- Select Reliability --</option>
                {% for reliability in reliabilities %}
                <option value="{{reliability.0}}">{{reliability.1}}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<script src="{% static 'js/add-entry.js' %}"></script>
<script src="{% static 'js/add-entry-map.js' %}"></script>

{% endblock %}
