{% extends 'base.html' %}
{% load staticfiles %}
{% load dict_access %}

{% block title %}
DEEP | Weekly Report
{% endblock %}

{% block head %}
<link href="{% static 'css/report-weekly.css' %}" type="text/css" rel="stylesheet">
<link href="{% static 'css/selectize.css' %}" type="text/css" rel="stylesheet">
<link href="{% static 'css/selectize.bootstrap3.css' %}" type="text/css" rel="stylesheet">
<script src="{% static 'js/entries/entries-filter.js' %}"></script>
<script src="{% static 'js/common/selectize.js' %}"></script>
<script src="{% static 'js/common/utils.js' %}"></script>
<script src="{% static 'js/report/report-weekly.js' %}"></script>

<script>

var eventId = "{{event.pk}}";
var csrf_token = "{% csrf_token %}";
{% if report %}
var data = JSON.parse("{{report.data|escapejs}}");
{% else %}
var data = {};
{% endif %}

if (!data["disaster_type"])
    data["disaster_type"] = null;
if (!data["status"])
    data["status"] = null;

if (!data["events"] || data["events"].length==0)
    data["events"] = [{"value":null, "start_date":null, "end_date":null, "category":null}];

if (!data["human"])
    data["human"] = { "number": {}, "source": {}, "comment": {} };

if (!data["people"]) {
    data["people"] = {
        "total": {}, "at-risk": {}, "moderate": {}, "severe": {}, "planned": {},
        "total-source": {}, "at-risk-source": {}, "moderate-source": {}, "severe-source": {}, "planned-source": {},
        "total-comment": {}, "at-risk-comment": {}, "moderate-comment": {}, "severe-comment": {}, "planned-comment": {},
    };
}
// Migration for "at-risk"
if (!data["people"]["at-risk"]) {
    data["people"]["at-risk"] = {};
    data["people"]["at-risk-source"] = {};
    data["people"]["at-risk-comment"] = {};
}

if (!data["ipc"])
    data["ipc"] = {"a":null, "b":null, "c":null, "d":null, "e":null, "f":null, "g":null};
if (!data["access"])
    data["access"] = {};
if (!data["access-pin"])
    data["access-pin"] = { "number": {}, "source": {}, "comment": {} };

if (!data["final-severity-score"])
    data["final-severity-score"] = { score: null, comment: null };

var csrf_token = "{% csrf_token %}";

{% if start_date %}
var start_date = "{{start_date|date:'d-M-Y'}}";
{% else %}
var start_date = "{{report.start_date|date:'d-M-Y'}}";
{% endif %}

var appearing_pillars = {
    {% for field, pillars in appearing_pillars.items %}{{field}}: [{% for pillar in pillars %}"{{pillar.pk}}", {% endfor %}], {% endfor %}
};

var human_profile_field_rules = [
    {% for rule in human_profile_field_rules %}
    {
        parent: '{{rule.parent_field.pk}}',
        children: [{% for child in rule.children.all %}'{{child.pk}}', {% endfor %}],
        comparision: '{{rule.comparision|safe}}'
    },
    {% endfor %}
];

{% if report %}
var editedAt = '{{report.last_edited_at|date:"Y-m-d"}}';
{% endif %}

// Some key figures to use in severity score
var under5MortalityRate = +'{{country.u5m}}';
var hdi = +'{{country.hdi_index}}';
var uprootedPercentage = +'{{country.uprooted_percentage}}';
</script>
{% endblock %}

{% block body %}
{% include 'navbar.html' %}
<section id="main">
    <div class="container-fluid">
        <header>
            <div class="row">
                <div class="col-md-8">
                    <h1>Weekly Report / <span>{{event}}</span></h1>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary btn-save" id="save-btn"><i class="fa fa-save"></i>Save Changes</button>
                    <button class="btn btn-danger btn-cancel" id="cancel-btn"><i class="fa fa-times"></i>Cancel</button>
                </div>
            </div>
            <div id="filters">
                {% include 'entries/entry-filters.html' %}
            </div>
        </header>
        <div class="row">
            <div class="col-md-4">
                <div id="entries-header-container">
                    <a id="last-seven-days-btn" href="#">Show entries from last 7 days</a>
                    <h3>Entries</h3>
                </div>
                <div id="entries">
                </div>
            </div>
            <div class="col-md-8">
                <div id="navigator">
                    <a data-target="#reporting-parameters" class="active">Reporting parameters</a>
                    <a data-target="#key-events">Key events</a>
                    <a data-target="#humanitarian-profile" data-pillar-tag="HPR">Humanitarian profile</a>
                    <a data-target="#people-in-need" data-pillar-tag="PIN">People in need</a>
                    <a data-target="#humanitarian-access" data-pillar-tag="HAC">Humanitarian access</a>
                    <a data-target="#weekly-severity-score" data-pillar-tag="WSC">Severity Score</a>
                </div>
                <div id="report-content">
                    <section id="reporting-parameters">
                        <div class="row">
                            <div class="col-md-6">
                                <label>Select week:</label>
                                <input class="form-control" type="week" id="week-select">
                            </div>
                            <div class="col-md-6">
                                <label>Select day:</label>
                                <select id="day-select" placeholder="Select a day">
                                    <option value="">Select a day </option>
                                    <option value="1">Monday</option>
                                    <option value="2">Tuesday</option>
                                    <option value="3">Wednesday</option>
                                    <option value="4">Thursday</option>
                                    <option value="5">Friday</option>
                                    <option value="6">Saturday</option>
                                    <option value="7">Sunday</option>
                                </select>
                            </div>
                        </div>
                        <br>
                        <br>
                        <div class="row">
                            <div class="col-md-6">
                                <label>Date of entry:</label>
                                <input class="form-control" type="date" id="date-of-entry">
                            </div>
                            <div class="col-md-6">
                                <label>Hour of entry:</label>
                                <input class="form-control" type="time" id="hour-of-entry">
                            </div>
                        </div>
                        <br>
                        <br>
                        <div class="row">
                            <div class="col-md-6">
                                <label>Select type of disaster:</label>
                                <select id="disaster-type-select" placeholder="Select type of disaster">
                                    <option>--Select type of disaster--</option>
                                    {% for type in disaster_types %}
                                    <option value="{{type.pk}}">{% if type.parent %}{{type.parent}} / {% endif %}{{type}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>Select status:</label>
                                <select id="status-select" placeholder="Select status">
                                    <option>--Select status--</option>
                                    {% for status in report_statuses %}
                                    <option value="{{status.pk}}">{{status}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </section>
                    <section id="key-events" hidden>
                        <div class="row">
                            <div class="col-md-12">
                                <label>Events for timeline:</label>
                                <div id="event-timeline-container">
                                </div>
                            </div>
                        </div>
                        <div class="event-timeline-template" hidden>
                            <div class="row">
                                <div class="col-md-9">
                                    <input class="form-control event-value">
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-default" >Add</button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3">
                                    <label>Start Date:</label>
                                    <input type="date" class="form-control start-date">
                                </div>
                                <div class="col-md-3">
                                    <label>End Date:</label>
                                    <input type="date" class="form-control end-date">
                                </div>
                                <div class="col-md-3">
                                    <label>Category:</label>
                                    <select class="category-select" placeholder="Select Category">
                                        <option>--Select category--</option>
                                    {% for category in category_timelines %}
                                        <option value="{{category.pk}}">{{category}}</option>
                                    {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <br>
                        </div>
                    </section>
                    <section id="humanitarian-profile" hidden>
                        <p id="humanitarian-profile-field-error" hidden>Value of <strong>bla bla</strong> should be greater than or equal to than that of <strong>bla blu</strong>!</p>
                        {% for field in human_profile_fields %}
                        <div class="row-group">
                            <div class="row">
                                <div class="col-md-6"><label>{{field.name}}</label></div>
                                <div class="col-md-2"><input class="human-number form-control{% if field.total_field %} human-profile-total{% endif %}{% if field.total_affected_field %} human-profile-total-affected{% endif %}" data-human-pk="{{field.pk}}" placeholder="Number of person"></div>
                                <div class="col-md-2"><input class="human-source form-control source-droppable" data-human-pk="{{field.pk}}" placeholder="Source/Date"></div>
                                <div class="col-md-2"><input class="human-comment form-control" data-human-pk="{{field.pk}}" placeholder="Comment"></div>
                            </div>

                            {% for subfield in field.humanprofilefield_set.all %}

                            <div class="row">
                                <div class="col-md-6"><label  class="sub">{{subfield.name}}</label></div>
                                <div class="col-md-2"><input class="human-number form-control{% if subfield.total_field %} human-profile-total{% endif %}{% if subfield.total_affected_field %} human-profile-total-affected{% endif %}" data-human-pk="{{subfield.pk}}" placeholder="Number of person"></div>
                                <div class="col-md-2"><input class="human-source form-control source-droppable" data-human-pk="{{subfield.pk}}" placeholder="Source/Date"></div>
                                <div class="col-md-2"><input class="human-comment form-control" data-human-pk="{{subfield.pk}}" placeholder="Comment"></div>
                            </div>

                            {% endfor %}
                        </div>
                        {% endfor %}
                    </section>
                    <section id="people-in-need" hidden>
                        {% for field in people_in_need_fields %}
                        <div class="row toplevel parent">
                            <div class="col-md-3">
                                <label>{{field.name}}{% if field.total_field %} (reported) {% endif %}</label>
                            </div>
                            <div class="col-md-9">
                                <div class="row">
                                    <div class="col-md-2"></div>
                                    <div class="col-md-2"><input class="people-total form-control {% if field.total_field %}people-in-need-total{% endif %}" data-people-pk="{{field.pk}}" placeholder="Total"></div>
                                    <div class="col-md-2"><input class="people-at-risk form-control" data-people-pk="{{field.pk}}" placeholder="At Risk"></div>
                                    <div class="col-md-2"><input class="people-moderate form-control" data-people-pk="{{field.pk}}" placeholder="Moderate"></div>
                                    <div class="col-md-2"><input class="people-severe form-control" data-people-pk="{{field.pk}}" placeholder="Severe"></div>
                                    <div class="col-md-2"><input class="people-planned form-control" data-people-pk="{{field.pk}}" placeholder="Planned"></div>
                                </div>

                                <div class="row">
                                    <div class="col-md-2"></div>
                                    <div class="col-md-2"><input class="people-total-source form-control source-droppable" data-people-pk="{{field.pk}}" placeholder="Source/Date"></div>
                                    <div class="col-md-2"><input class="people-at-risk-source form-control source-droppable" data-people-pk="{{field.pk}}" placeholder="Source/Date"></div>
                                    <div class="col-md-2"><input class="people-moderate-source form-control source-droppable" data-people-pk="{{field.pk}}" placeholder="Source/Date"></div>
                                    <div class="col-md-2"><input class="people-severe-source form-control source-droppable" data-people-pk="{{field.pk}}" placeholder="Source/Date"></div>
                                    <div class="col-md-2"><input class="people-planned-source form-control source-droppable" data-people-pk="{{field.pk}}" placeholder="Source/Date"></div>
                                </div>
                                <div class="row">
                                    <div class="col-md-2"></div>
                                    <div class="col-md-2"><input class="people-total-comment form-control" data-people-pk="{{field.pk}}" placeholder="Comment"></div>
                                    <div class="col-md-2"><input class="people-at-risk-comment form-control" data-people-pk="{{field.pk}}" placeholder="Comment"></div>
                                    <div class="col-md-2"><input class="people-moderate-comment form-control" data-people-pk="{{field.pk}}" placeholder="Comment"></div>
                                    <div class="col-md-2"><input class="people-severe-comment form-control" data-people-pk="{{field.pk}}" placeholder="Comment"></div>
                                    <div class="col-md-2"><input class="people-planned-comment form-control" data-people-pk="{{field.pk}}" placeholder="Comment"></div>
                                </div>
                            </div>
                        </div>

                        {% if field.total_field %}
                        <div class="row toplevel parent">
                            <div class="col-md-3">
                                <label>{{field.name}}{% if field.total_field %} (calculated) {% endif %}</label>
                            </div>
                            <div class="col-md-9">
                                <div class="row">
                                    <div class="col-md-2"></div>
                                    <div class="col-md-2"><input class="people-total-calculated form-control" data-people-pk="{{field.pk}}" placeholder="Total"></div>
                                    <div class="col-md-2"><input class="people-at-risk-calculated form-control" data-people-pk="{{field.pk}}" placeholder="At Risk"></div>
                                    <div class="col-md-2"><input class="people-moderate-calculated form-control" data-people-pk="{{field.pk}}" placeholder="Moderate"></div>
                                    <div class="col-md-2"><input class="people-severe-calculated form-control" data-people-pk="{{field.pk}}" placeholder="Severe"></div>
                                    <div class="col-md-2"><input class="people-planned-calculated form-control" data-people-pk="{{field.pk}}" placeholder="Planned"></div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% for subfield in field.peopleinneedfield_set.all %}
                        <div class="row toplevel">
                            <div class="col-md-3">
                                <div class="row">
                                    <div class="col-md-12">
                                        <label class="sub">{{subfield.name}}</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="row">
                                    <div class="col-md-2"></div>
                                    <div class="col-md-2"><input class="people-total form-control {% if field.total_field %}total-subfield{% endif %}" data-people-pk="{{subfield.pk}}" placeholder="Total"></div>
                                    <div class="col-md-2"><input class="people-at-risk form-control {% if field.total_field %}total-at-risk-subfield{% endif %}" data-people-pk="{{subfield.pk}}" placeholder="At Risk"></div>
                                    <div class="col-md-2"><input class="people-moderate form-control {% if field.total_field %}total-moderate-subfield{% endif %}" data-people-pk="{{subfield.pk}}" placeholder="Moderate"></div>
                                    <div class="col-md-2"><input class="people-severe form-control {% if field.total_field %}total-severe-subfield{% endif %}" data-people-pk="{{subfield.pk}}" placeholder="Severe"></div>
                                    <div class="col-md-2"><input class="people-planned form-control {% if field.total_field %}total-planned-subfield{% endif %}" data-people-pk="{{subfield.pk}}" placeholder="Planned"></div>
                                </div>
                                <div class="row">
                                    <div class="col-md-2"></div>
                                    <div class="col-md-2"><input class="people-total-source form-control source-droppable" data-people-pk="{{subfield.pk}}" placeholder="Source/Date"></div>
                                    <div class="col-md-2"><input class="people-at-risk-source form-control source-droppable" data-people-pk="{{subfield.pk}}" placeholder="Source/Date"></div>
                                    <div class="col-md-2"><input class="people-moderate-source form-control source-droppable" data-people-pk="{{subfield.pk}}" placeholder="Source/Date"></div>
                                    <div class="col-md-2"><input class="people-severe-source form-control source-droppable" data-people-pk="{{subfield.pk}}" placeholder="Source/Date"></div>
                                    <div class="col-md-2"><input class="people-planned-source form-control source-droppable" data-people-pk="{{subfield.pk}}" placeholder="Source/Date"></div>
                                </div>
                                <div class="row">
                                    <div class="col-md-2"></div>
                                    <div class="col-md-2"><input class="people-total-comment form-control" data-people-pk="{{subfield.pk}}" placeholder="Comment"></div>
                                    <div class="col-md-2"><input class="people-at-risk-comment form-control" data-people-pk="{{subfield.pk}}" placeholder="Comment"></div>
                                    <div class="col-md-2"><input class="people-moderate-comment form-control" data-people-pk="{{subfield.pk}}" placeholder="Comment"></div>
                                    <div class="col-md-2"><input class="people-severe-comment form-control" data-people-pk="{{subfield.pk}}" placeholder="Comment"></div>
                                    <div class="col-md-2"><input class="people-planned-comment form-control" data-people-pk="{{subfield.pk}}" placeholder="Comment"></div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% endfor %}
                        <div class="row toplevel">
                            <div class="col-md-4">
                                <div class="row">
                                    <div class="col-md-12">
                                        <label class="sub">IPC</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-md-3"><label class="sub">1. None/Minimal</label></div>
                                    <div class="col-md-3"><input data-ipc="a" class="form-control" placeholder="Number"></div>
                                    <div class="col-md-3"><label class="sub">4. Emergency</label></div>
                                    <div class="col-md-3"><input data-ipc="b" class="form-control" placeholder="Number"></div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3"><label class="sub">2. Stressed</label></div>
                                    <div class="col-md-3"><input data-ipc="c" class="form-control" placeholder="Number"></div>
                                    <div class="col-md-3"><label class="sub">5. Famine</label></div>
                                    <div class="col-md-3"><input data-ipc="d" class="form-control" placeholder="Number"></div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3"><label class="sub">3. Crisis</label></div>
                                    <div class="col-md-3"><input data-ipc="e" class="form-control" placeholder="Number"></div>
                                    <div class="col-md-6"><input data-ipc="f" class="form-control" placeholder="Source"></div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12"><input data-ipc="g" class="form-control" placeholder="Comment"></div>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section id="humanitarian-access" hidden>
                        <div class="row">
                            <div class="col-md-7">
                                {% for field in human_access_fields %}
                                <div class="row">
                                    <div class="col-md-8"><label class="title">{{field.name}}</label></div>
                                    <div class="col-md-4">
                                        <select class="access-select" data-access-pk="{{field.pk}}">
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                            <option value="DNK">DNK</option>
                                        </select>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="col-md-5 right-pane">
                                {% for field in human_access_pin_fields %}
                                <div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="title">{{field.name}}</label>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                <input class="form-control access-pin-number" data-access-pin-pk="{{field.pk}}" placeholder="Number">
                                            </div>
                                        </div>
                                        <div class="col-md-7">
                                            <div class="form-group">
                                                <input class="form-control access-pin-source source-droppable" data-access-pin-pk="{{field.pk}}" placeholder="Source/Date">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <input class="form-control access-pin-comment" data-access-pin-pk="{{field.pk}}" placeholder="Comment">
                                    </div>

                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </section>
                    <section id="weekly-severity-score" hidden>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-3">
                                    <label>Final Severity Score</label>
                                    <input id="final-score" class="form-control score" type="number" min="0" max="3" step="1">
                                </div>
                                <div class="col-md-6">
                                    <label>Comment</label>
                                    <input id="final-score-comment" class="form-control" placeholder="Comment">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-3">
                                    <label>Calculated Score</label>
                                    <input id="calculated-score" class="form-control" readonly="readonly">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-3">
                                    <label>% of popn in need or recently affected </label>
                                    <input id="pin-percentage" class="form-control" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label> Score</label>
                                    <input id="pin-percentage-score" class="form-control score" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-3">
                                    <label>Humanitarian Access</label>
                                    <input id="level-of-access" class="form-control" placeholder="Number (0-9)" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label> Score</label>
                                    <input id="level-of-access-score" class="form-control score" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-3">
                                    <label>Under 5 Mortality Rate</label>
                                    <input id="mortality-rate" class="form-control" placeholder="Number" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label> Score</label>
                                    <input id="mortality-rate-score" class="form-control score" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-3">
                                    <label>Human Development Index</label>
                                    <input id="hdi" class="form-control" placeholder="Number" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label> HDI Rank</label>
                                    <input id="hdi-rank" class="form-control" placeholder="HDI Rank" readonly>
                                </div>.
                                <div class="col-md-3">
                                    <label> Score</label>
                                    <input id="hdi-score" class="form-control score" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-3">
                                    <label>Uprooted People</label>
                                    <input id="uprooted-people" class="form-control" placeholder="Number" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label> % of total population</label>
                                    <input id="uprooted-percentage" class="form-control" placeholder="% of total population" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label> Score</label>
                                    <input id="uprooted-score" class="form-control score" readonly>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>
</section>
{% include 'report/weekly-entry-templates.html' %}
{% endblock %}
