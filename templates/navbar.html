{% load watchful_url %}

<script>
    $(document).ready(function(){
        {% if all_events %}
        var currentDropdownVal = $('#crisis-dropdown').val();

        var crisisDropdown = $('#crisis-dropdown').selectize({
            onDropdownOpen: function(dropdown) {
                crisisDropdown.clear();
                dropdown.stop().hide().slideToggle();
            },
            onDropdownClose: function(dropdown) {
                if(crisisDropdown.getValue() == ''){
                    crisisDropdown.setValue(currentDropdownVal);
                }
                dropdown.stop().show().slideToggle();
            }
        })[0].selectize;
        $('#crisis-dropdown').change(function() {
            if ($(this).val() != null && $(this).val() != '' && $(this).val() != currentDropdownVal){
                window.location.href = $(this).val();
            }
        });
        {% endif %}

        // HumanitarianId link
        $('#link-with-hid').click(function() {
            {% if hid_config and hid_config.development %}
            window.location.href = 'http://auth.dev.humanitarian.id/oauth/authorize?response_type=token&client_id={{ hid_config.client_id|safe }}&scope=profile&state=833912&redirect_uri={{ hid_config.redirect_url|safe }}';
            {% else %}
            window.location.href = 'http://auth.humanitarian.id/oauth/authorize?response_type=token&client_id={{ hid_config.client_id|safe }}&scope=profile&state=833912&redirect_uri={{ hid_config.redirect_url|safe }}';
            {% endif %}
        });

        if (window.location.hash.indexOf('access_token=') >= 0
            && window.location.hash.indexOf('state=833912') >= 0)
        {
            window.location.href = '{% url "hid_access_token" %}' + '?' + window.location.hash.substr(1);
        }

        $('body nav').on('click', '.dropdown-toggle', function(){
            $(this).closest('.dropdown').find('.items').toggle();
        });
        $('body nav').on('blur', '.dropdown', function(){
            $(this).find('.items').hide();
        });

        $('div[data-url]').click(function() {
            window.location.href = $(this).data('url');
        });
    });
</script>

<nav>
    <!-- DEEP logo -->
    <div id="deep-logo-container">
        {% if event %}
        <a href="{% url 'dashboard' event=event.pk%}"><img src="{% watchful_static_url 'img/deep-logo-white.png' %}"></a>
        {% else %}
        <a href="{% url 'dashboard' %}?last_event=1"><img src="{% watchful_static_url 'img/deep-logo-white.png' %}"></a>
        {% endif %}
    </div>

    <!-- Report -->
    <div id=report-link-container>
        <a class="{% if current_page == 'report' %}active{% endif %} menu-item" href="{% url 'report:dashboard' %}{% if event %}?event={{event.pk}}&country={{event.countries.all.0.code}}{% endif %}">Report</a>
    </div>

    <!-- Event selector -->
    <div id="crisis-select-container">
        {% if all_events %}
        <select id="crisis-dropdown" placeholder="Select event">
            <option>Select event</option>
            {% if event %}
            <option value="{% url 'dashboard' %}">None</option>
            {% endif %}
            {% for ev in all_events %}
            <option value="{% url request.resolver_match.view_name event=ev.pk %}" {% if event and event == ev %}selected{% endif %}>{{ev}}</option>
            {% endfor %}
        </select>
        {% else %}
        {% if event %}
        <a href="#" style="color: #fff; font-weight: bold; width: 100%; overflow: hidden;"><span class="fa fa-location-arrow" style="margin-right: 8px;"></span>{{event}}</a>
        {% endif %}
        {% endif %}
    </div>

    <!-- Main menu -->
    <div id="main-menu">
        {% if event %}
        <a class="{% if current_page == 'leads' %}active{% endif %} menu-item" href="{% url 'leads:leads' event=event.pk %}">Leads</a>
        <a class="{% if current_page == 'entries' %}active{% endif %} menu-item" href="{% url 'entries:entries' event=event.pk %}">Entries</a>
        <a class="{% if current_page == 'sos' %}active{% endif %} menu-item" href="{% url 'leads:sos' event=event.pk %}">Survey of surveys</a>
        <a class="{% if current_page == 'export' %}active{% endif %} menu-item" href="{% url 'entries:export' event=event.pk %}">Export</a>
        {% endif %}
    </div>
    <div id="extra-menu">
        <!-- Chrome extension download -->
        <a id="chrome-extension-download-link" target="_blank" title="Download Chrome Extension" href="https://chrome.google.com/webstore/detail/deep-create-lead/ggplhkhciodfdkkonmhgniaopboeoopi"><i class="fa fa-chrome fa-spin"></i></a>

        <!-- User menu -->
        <div class="dropdown" id="user-menu" tabindex="-1">
            <a class="dropdown-toggle"><div class="name"><i class="fa fa-user"></i>{{ user.first_name }}</div><i class="fa fa-chevron-down"></i></a>
            <div class="items" hidden>
                <div data-url="{% url 'user_profile' user.pk %}"><i class="fa fa-user"></i>Profile</small></div>
                <div data-url="{% url 'logout' %}"><i class="fa fa-sign-out"></i>Logout</div>
                {% if request.user.is_superuser %}
                <hr>
                <div data-url="/admin"><i class="fa fa-user-secret"></i>Admin panel</div>
                <div data-url="{% url 'custom_admin:country_management' %}"><i class="fa fa-globe"></i>Country Panel</div>
                <div data-url="{% url 'custom_admin:crisis_panel' %}"><i class="fa fa-wrench"></i>Crisis Panel</div>
                {% endif %}
                {% if request.user.userprofile.hid %}
                <hr>
                <!-- TODO: Maybe show link to official hid profile page -->
                {% else %}
                <hr>
                <div id="link-with-hid" data-url="#"><i class="fa fa-link"></i>Link with HID</div>
                {% endif %}
            </div>
        </div>
    </div>
</nav>
